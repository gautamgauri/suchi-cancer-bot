# Re-run only failed/errored cases from the 100-case suite
# Uses the error cohort CSV generated by analyze-100case-failures.js

param(
    [string]$ErrorCsv = "phase3-100case-error-cohort.csv",
    [string]$OutputDir = "reports/failed-rerun",
    [switch]$DryRun
)

if (-not (Test-Path $ErrorCsv)) {
    Write-Host "Error cohort CSV not found: $ErrorCsv" -ForegroundColor Red
    Write-Host "Run: node analyze-100case-failures.js" -ForegroundColor Yellow
    exit 1
}

New-Item -ItemType Directory -Force -Path $OutputDir | Out-Null

$rows = Import-Csv $ErrorCsv
$caseIds = $rows | Select-Object -ExpandProperty caseId

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "RE-RUN FAILED CASES" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Total failed cases: $($caseIds.Count)" -ForegroundColor Yellow
Write-Host "Output dir: $OutputDir" -ForegroundColor Yellow
Write-Host ""

if ($DryRun) {
    Write-Host "Dry run - cases to execute:" -ForegroundColor Gray
    $caseIds | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }
    exit 0
}

$timestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
$reportFiles = @()

foreach ($caseId in $caseIds) {
    Write-Host "`nRunning: $caseId" -ForegroundColor Cyan
    $outFile = Join-Path $OutputDir "$caseId-$timestamp.json"
    $reportFiles += $outFile
    npx ts-node cli.ts run `
        --cases cases/tier1/common_cancers_20_mode_matrix.yaml `
        --case $caseId `
        --output $outFile `
        --summary | Out-Null
}

Write-Host "`nAll failed cases re-run complete." -ForegroundColor Green
Write-Host "Merging reports..." -ForegroundColor Yellow

node scripts/merge-reports.js $OutputDir "$OutputDir/failed-rerun-merged-$timestamp.json"

Write-Host "`nMerged report written to:" -ForegroundColor Green
Write-Host "  $OutputDir/failed-rerun-merged-$timestamp.json" -ForegroundColor Gray
